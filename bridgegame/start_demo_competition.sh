#!/bin/bash

# =============================================================================
# Demo对战启动脚本
# =============================================================================
# 本脚本用于启动完整的Demo对战流程，包括：
#   1. 启动桥牌游戏环境服务器（相邻两个端口）
#   2. 启动所有AI对战者服务
#   3. 启动竞技场系统进行对战
#   4. 生成对战报告
#
# 注意事项：
#   - 桥牌服务器需要在相邻的两个端口上启动（如9030和9031）
#   - 配置文件中只需记录第一个端口（9030）
#   - 桥牌是4人游戏，需要至少4个AI实例
# =============================================================================

# 获取脚本所在目录的绝对路径
cur_dir=$(dirname "$0")

# =============================================================================
# 端口管理函数
# =============================================================================
# 功能：杀死占用指定端口的进程，确保端口可用
kill_port() {
    if [ -z "$1" ]; then
        echo "用法: kill_port <端口号>"
        return 1
    fi
    PORT=$1
    # 使用lsof命令查找占用端口的进程ID
    PID=$(sudo lsof -ti :"$PORT" 2>/dev/null)
    if [ -z "$PID" ]; then
        echo "端口 $PORT 未被任何进程占用。"
        return 0
    fi
    # 强制杀死占用端口的进程
    sudo kill -9 $PID
    echo "已杀死占用端口 $PORT 的进程: $PID"
}

# 切换到脚本所在目录
cd $cur_dir

# =============================================================================
# 步骤1：启动桥牌游戏环境服务器
# =============================================================================
echo "=== 启动桥牌游戏环境 ==="
cd bridge

# 桥牌服务器需要在相邻的两个端口上启动
# 清理端口9030和9031，确保游戏环境服务器可以正常启动
kill_port 9030
kill_port 9031

# 启动游戏环境服务器，监听9030端口（会自动使用9031作为第二个端口）
echo "启动桥牌服务器在端口 9030-9031..."
bash start_server.sh &

# 等待5秒让服务器完全启动
sleep 5
cd ../

# =============================================================================
# 步骤2：启动AI对战者服务
# =============================================================================
echo "=== 启动AI对战者服务 ==="
# 回到脚本所在目录
cd $cur_dir
# 显示当前目录内容（用于调试）
ls

# 启动所有AI对战者，使用默认参数：
# - round=1 (启动round_1目录下的AI)
# - env=bridge (启动bridge环境下的AI)
# - start_port=50001 (从50001端口开始分配)
echo "启动AI服务..."
bash start_ai_competitors.sh 

# 等待5秒让所有AI服务完全启动
sleep 5

# =============================================================================
# 步骤3：启动竞技场系统进行对战
# =============================================================================
echo "=== 启动竞技场对战系统 ==="
# 回到脚本所在的目录
cd $cur_dir

# 检查是否存在demo配置文件
if [ ! -f "./bridge_Arena/configs/demo_config.json" ]; then
    echo "警告: demo_config.json 不存在，请先创建配置文件"
    echo "可以参考 bridge_Arena/configs/ 目录下的示例配置"
    exit 1
fi

# 启动竞技场系统，使用demo配置文件
# --config: 指定对战配置文件
# --reports-dir: 指定对战报告输出目录
echo "启动竞技场对战..."
python3 ./bridge_Arena/start_arena.py \
  --config ./bridge_Arena/configs/demo_config.json \
  --tournament-type duplicate 
  
echo ""
echo "================================"
echo "Demo对战完成！"
echo "报告保存在: ./bridge_Arena/reports/demo_competition"
echo "================================"

